#!/usr/bin/env bash

# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# installs a grinder


if [ -z $1 ]; then
  echo "Cluster name required!"
  exit -1
fi

CLUSTER=$1


# Import variables
bin=`dirname "$0"`
bin=`cd "$bin"; pwd`
. "$bin"/benchmark-ec2-env.sh
. "$bin"/functions


# copy to master
echo "Installing grinder on master."

getMaster $CLUSTER
# call $MASTER "wget $GRINDER_URL" > /dev/null
GRINDER_FILE=`call $MASTER "ls -d grinder-*.zip" | sed -e s/$'\r'//g`
call $MASTER "unzip -o $GRINDER_FILE -d /opt" > /dev/null 
GRINDER_HOME=`call $MASTER "ls -d /opt/grinder-*" | sed -e s/$'\r'//g`
scp $SSH_OPTS -r $bin/../src/main/scripts "root@$MASTER:$GRINDER_HOME" > /dev/null

echo "Configuring grinder on the master"
getMasterInternal $CLUSTER

call $MASTER "sed -i -e 's|; grinder.consoleHost =.*|grinder.consoleHost = $MASTER_INTERNAL|' \
   	       $GRINDER_HOME/scripts/grinder.properties"
  
  call $MASTER "nohup /usr/local/jdk${JAVA_VERSION}/bin/java -cp $GRINDER_HOME/lib/grinder.jar net.grinder.Console -headless & "

# getting instances
echo "Coping grinder to all nodes"
getNodes $CLUSTER
for NODE in $NODES
do
  call $MASTER "scp -r $GRINDER_HOME $NODE:$GRINDER_HOME" > /dev/null
  call $NODE "nohup /usr/local/jdk${JAVA_VERSION}/bin/java -cp $GRINDER_HOME/lib/grinder.jar net.grinder.Grinder $GRINDER_HOME/scripts/grinder.properties & "
done
# start the master

echo "Grinder installed."
