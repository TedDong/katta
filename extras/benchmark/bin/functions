#!/usr/bin/env bash

# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Gernal variables make sure you dont use them in the shell script that uses this file.

MASTER=""
MASTER_INTERNAL=""
NODES=""
NODES_INTERNAL=""

# some helper functions
function call {
	ssh $SSH_OPTS -t "root@$1" "$2" 2> /dev/null
}

#gets the master of a given cluster name
function getMaster {
 if [ -z $1 ]; then
   echo "Cluster name required!"
   exit -1
 fi
 CLUSTER_NAME=$1-master
 MASTER=`ec2-describe-instances | awk '"RESERVATION" == $1 && "'$CLUSTER_NAME'" == $4, "RESERVATION" == $1 && "'$CLUSTER_NAME'" != $4'`
 MASTER=`echo "$MASTER" | awk '"INSTANCE" == $1 && "running" == $6 {print $4}'`
}

#gets the master internal hostname of a given cluster name
function getMasterInternal {
 if [ -z $1 ]; then
   echo "Cluster name required!"
   exit -1
 fi
 CLUSTER_NAME=$1-master
 MASTER_INTERNAL=`ec2-describe-instances | awk '"RESERVATION" == $1 && "'$CLUSTER_NAME'" == $4, "RESERVATION" == $1 && "'$CLUSTER_NAME'" != $4'`
 MASTER_INTERNAL=`echo "$MASTER_INTERNAL" | awk '"INSTANCE" == $1 && "running" == $6 {print $5}'`
}

# getting the nodes for a given cluster name
function getNodes {
	if [ -z $1 ]; then
   		echo "Cluster name required!"
   		exit -1
 	fi	
	NODES=`ec2-describe-instances | awk '"RESERVATION" == $1 && "'$1'" == $4, "RESERVATION" == $1 && "'$1'" != $4'`
	NODES=`echo "$NODES" | grep INSTANCE | grep running | awk '{print $4}'`
 
}

# getting the nodes internal hostname for a given cluster name
function getNodesInternal {
	
	if [ -z $1 ]; then
   		echo "Cluster name required!"
   		exit -1
 	fi	
	NODES_INTERNAL=`ec2-describe-instances | awk '"RESERVATION" == $1 && "'$1'" == $4, "RESERVATION" == $1 && "'$1'" != $4'`
	NODES_INTERNAL=`echo "$NODES_INTERNAL" | grep INSTANCE | grep running | awk '{print $5}'`
 
}