import java.text.DateFormat
import java.text.SimpleDateFormat
import org.gradle.api.tasks.StopExecutionException

archivesBaseName = 'katta'
group = 'net.sf.katta'
version = '1.0-SNAPSHOT'
snapShotVersion = version
String timestamp = ""
int buildNumber = 1;
String distributionNumber = version;

String maven2Group = group.toString().replaceAll('\\.', '/');
File uploadFolder = buildDir


usePlugin('java')

sourceCompatibility = 1.5
targetCompatibility = 1.5

createTask('wrapper', type: Wrapper).configure {
  urlRoot = 'http://snapshots.dist.codehaus.org/gradle/'
  gradleVersion = '0.3-080716153750+0200'
  jarPath = 'src/build/resources/lib'
}


Map requiredProperties = [
  kattaDevelopRepositoryUri: hasProperty('kattaDevelopRepositoryUri'),
  kattaDistributionRepositoryUri: hasProperty('kattaDistributionRepositoryUri'),
  kattaSshUser: hasProperty('kattaSshUser'),
  kattaSshPassword: hasProperty('kattaSshPassword'),
  kattaSshHost: hasProperty('kattaSshHost'),
]

public class JarFilter implements FileFilter {

  public boolean accept(File file) {
    return file.getName().endsWith(".jar");
  }

}

test {
  include '**/*Test.class'
}


dependencies {
  addFlatDirResolver('lib', new File(rootDir, 'lib'))

  // todo create clientModule for hadoop etc.
  compile ":hadoop-core:0.16.3", ":lucene-core:2.3.2"
  compile ":zookeeper:2.2.0"
  compile ":commons-cli:2.0-SNAPSHOT"
  compile ":commons-codec:1.3"
  compile ":jets3t:0.5.0"
  compile ":xmlenc:0.52"
  compile ":commons-httpclient:3.0.1"
  compile ":zookeeper:2.2.0"
  compile ":commons-logging:1.0.4"
  compile ":commons-logging-api:1.0.4"
  compile ":log4j:1.2.13"

  def HAMCREST = [":hamcrest-core:1.1", ":hamcrest-library:1.1"]

  clientModule(['testCompile'], ":jmock:2.4.0") {
    dependencies(HAMCREST as String[])
  }
  testCompile HAMCREST, ":junit:3.8.1"
}

//configure snapShot version
init {
  if (requiredProperties.kattaDevelopRepositoryUri && requiredProperties.kattaSshUser && requiredProperties.kattaSshPassword && requiredProperties.kattaSshHost) {
    buildDir.mkdir();
    ant.sshexec(host: "$kattaSshHost", username: "$kattaSshUser", password: "$kattaSshPassword", command: "ls $kattaDevelopRepositoryUri/$maven2Group/$archivesBaseName/$version/*.jar | wc -l", output: "$buildDir/version.txt");

    BufferedReader reader = new BufferedReader(new FileReader(new File(buildDir, "version.txt")))
    String line = reader.readLine();
    reader.close();
    line = line.trim();
    uploadFolder = new File(kattaDevelopRepositoryUri + "/$maven2Group/$archivesBaseName/$version");
    try {
      buildNumber = Integer.parseInt(line) + 1;
    } catch (NumberFormatException e) {
      //nothing todo
    }
  }
  String pattern = "yyyyMMdd.hhmmss";
  DateFormat dateFormat = new SimpleDateFormat(pattern);
  timestamp = dateFormat.format(new Date());
  snapShotVersion = version.replaceAll("SNAPSHOT", "") + timestamp + "-" + buildNumber;
  distributionNumber = version.replaceAll("-SNAPSHOT", "") + "." + buildNumber;
}

//collect runtime libs for the distribution
File runtimeLibsDir = new File(buildDir, 'runtimeLibs')
createTask('collectRuntimeLibs') {
  runtimeLibsDir.mkdirs()
  dependencies.resolve('runtime').each {File file ->
    ant.copy(file: file, todir: runtimeLibsDir)
  }
  ant.copy(file: archive_jar.archivePath, toDir: runtimeLibsDir)
}

//lib tasks
libs() {
  jar(baseName: "archive_job") {
    extension = "job"
    mergeGroup(runtimeLibsDir)
    merge(archive_jar.archivePath)
    publish = false
  }
  archive_job_jar.dependsOn('archive_jar', 'collectRuntimeLibs')
}


uploadLibs.doFirst {
  if (!requiredProperties.kattaDevelopRepositoryUri || !requiredProperties.kattaSshUser || !requiredProperties.kattaSshPassword || !requiredProperties.kattaSshHost) {
    throw new StopExecutionException("Please define a 'kattaDevelopRepositoryUri' in $gradleUserHome/gradle.properties");
  }
}

// we only support the upload via scp
uploadLibs {
  if (requiredProperties.kattaDevelopRepositoryUri && requiredProperties.kattaSshUser && requiredProperties.kattaSshPassword && requiredProperties.kattaSshHost) {
    org.apache.ivy.plugins.resolver.SshResolver resolver = new org.apache.ivy.plugins.resolver.SshResolver()
    resolver.name = 'Katta Develop Repository'
    resolver.userPassword = kattaSshPassword
    resolver.setArtifactPatterns(['ssh://' + kattaSshUser + '@' + kattaSshHost + ':' + kattaDevelopRepositoryUri + '/[organisation]/[artifact]/[revision]/[artifact]-' + snapShotVersion + '.[ext]'])
    resolver.m2compatible = true
    resolver.setPublishPermissions("0644");
    uploadResolvers.add(resolver)
  }
}

uploadLibs.doLast {
  if (!requiredProperties.kattaDevelopRepositoryUri) {
    throw new StopExecutionException("Please define a 'kattaDevelopRepositoryUri' in $gradleUserHome/gradle.properties");
  }

  //upload maven pom.xml
  File pom = new File(buildDir, "/$archivesBaseName-$snapShotVersion" + ".pom");
  ant.copy(file: 'src/build/resources/pom.xml', toFile: pom);
  ant.scp(file: pom, toDir: "$kattaSshUser@$kattaSshHost:$uploadFolder", password: "$kattaSshPassword");

  //upload maven - metadata.xml
  File metadataFile = new File(buildDir, "maven-metadata.xml")
  BufferedReader reader = new BufferedReader(new FileReader("src/build/resources/maven-metadata.xml"))
  BufferedWriter writer = new BufferedWriter(new FileWriter(metadataFile));
  String line = null;
  while ((line = reader.readLine()) != null) {
    if (line.contains("timestamp")) {
      line = "<timestamp>" + timestamp + "</timestamp>"
    } else if (line.contains("buildNumber")) {
      line = "<buildNumber>" + buildNumber + "</buildNumber>";
    } else if (line.contains("lastUpdated")) {
      line = "<lastUpdated>" + timestamp.replace('.', '') + "</lastUpdated>";
    }
    writer.writeLine(line);
  }
  reader.close();
  writer.close();
  ant.scp(file: metadataFile, toDir: "$kattaSshUser@$kattaSshHost:$uploadFolder", password: "$kattaSshPassword");
}

//dists task
dists {
  String zipRoot = "$archivesBaseName-$distributionNumber"
  zip() {
    zipFileSet(dir: file('bin'), prefix: "$zipRoot/bin", fileMode: '775')
    zipFileSet(dir: file('conf'), prefix: "$zipRoot/conf")
    zipFileSet(dir: runtimeLibsDir, prefix: "$zipRoot/lib")
  }
}

archive_zip.doFirst {
  distsDir.mkdirs()
}

archive_zip.doLast {
  ant {
    exec(executable: 'unzip') {
      arg(value: '-q')
      arg(value: '-d')
      arg(value: distsDir)
      arg(value: archive_zip.archivePath)
    }
  }
}

uploadDists.doFirst {
  if (!requiredProperties.kattaDistributionRepositoryUri || !requiredProperties.kattaSshUser || !requiredProperties.kattaSshPassword || !requiredProperties.kattaSshHost) {
    throw new StopExecutionException("Please define a 'kattaDistributionRepositoryUri' in $gradleUserHome/gradle.properties");
  }
}

// we only support the upload via scp
uploadDists {
  if (requiredProperties.kattaDistributionRepositoryUri && requiredProperties.kattaSshUser && requiredProperties.kattaSshPassword && requiredProperties.kattaSshHost) {
    org.apache.ivy.plugins.resolver.SshResolver resolver = new org.apache.ivy.plugins.resolver.SshResolver()
    resolver.name = 'Katta Distribution Repository'
    resolver.userPassword = kattaSshPassword

    resolver.setArtifactPatterns(['ssh://' + kattaSshUser + '@' + kattaSshHost + ':' + kattaDistributionRepositoryUri + '/[artifact]-' + distributionNumber + '.[ext]'])
    resolver.setPublishPermissions("0644");
    uploadResolvers.add(resolver);
  }
}
